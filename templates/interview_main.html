{% extends "mainpage.html" %}

{% block content%}

<section id="header">
    <h1><a href="{% url 'audiotest:index' %}">jUmP</a></h1>
    <nav id="nav">
        <ul>
            <li id="btn_home"><a href="{% url 'audiotest:index' %}">Home</a></li>
            <li class="current" id="btn_interview"><a href="{% url 'audiotest:interview' %}">Interview</a></li>
            <li id="btn_employment_info"><a href="{% url 'docu:index' %}">Employment info.</a></li>
            {% if user.is_authenticated %}
            <li id="btn_mypage"><a href="{% url 'audiotest:privacy' %}">Mypage</a></li>
            <li id="btn_logout"><a href="{% url 'audiotest:logout' %}">Logout</a></li>
            {% else %}
            <li id="btn_login"><a href="{% url 'audiotest:login' %}">Login</a></li>
            {% endif %}
        </ul>
    </nav>
</section>
<section id="main">
    <div class="container">
        <div class="row">
            <div class="col-5 col-12-medium">

                <!-- Sidebar -->
                    <section class="box">
                        <video playsinline muted id="record_video" autoplay style="width: 29em;"></video>
                    </section>
                    <section class="box">
                        <header>
                            <h3>녹화영상 재생</h3>
                        </header>
                        <video playsinline id="replay_video" style="width: 29em;"></video>
                    </section>

            </div>
            <div class="col-7 col-12-medium imp-medium">
                <!-- Content -->
                    <article class="box post">
                        <div class="interview-buttons">
                            <button id="record"> Record </button>
                            <button id="stop"> Stop </button>
                            <button id="play"> Play </button>
                            <button id="download"> Download </button>
                            <span class="time_table"><b> 남은 시간: <span class="time" id="time"></span></b></span>
                        </div>
                        <b>
                        {% if question_list %}
                        <ul>
                            <br>
                            인성 질문
                            <br>
                            <br>
                            {% for question in question_list %}
                            {{ forloop.counter }}.
                            {{ question.question_text }}
                            <br>
                            <br>
                            {% endfor %}
                        </ul>
                        {% endif %}
                        {% if question_list1 %}
                        <ul>
                            기술 질문
                            <br>
                            <br>
                            {% for question in question_list1 %}
                            {{ forloop.counter }}.
                            {{ question.question_text }}
                            <br>
                            <br>
                            {% endfor %}
                            </ul>
                        {% endif %}
                        <b> 
                    </article>

            </div>
        </div>
</section>
<script type="text/javascript">
    window.onload = function () {

        // 타이머 관련 설정
        document.getElementById("time").innerText = "90초";
        let timee = 90;
        // 타이머 함수
        let timer_output = function() {
            timee = timee - 1;
            document.getElementById("time").innerText = String(timee) + "초";
            if (timee <= 0) {
                clearInterval(timer);
            }
        }
        
        let timer;

        // 녹화 관련 변수 생성
        const parts = []; // 프레임 저장용 array
        let mediaRecorder; 
        let url;

        // 웹캠 화면 출력 및 녹화 시작
        navigator.mediaDevices.getUserMedia({ audio: true, video: true }).then(stream => {
        document.getElementById("record_video").srcObject = stream;
        document.getElementById("record").onclick = function () {
            mediaRecorder = new MediaRecorder(stream);
            timer = setInterval(timer_output, 1000);
            mediaRecorder.start(0);
            mediaRecorder.ondataavailable = function (e) {
                parts.push(e.data);
                if (timee <= 0) {
                    mediaRecorder.stop(0);
                    const blob = new Blob(parts, {
                        type: "video/webm"
                    });
                    url = URL.createObjectURL(blob);
                    setTimeout(function() {
                        document.getElementById("time").innerText = "90초";
                    }, 1000);
                }
                }
            }
        });

        // 녹화 중지
        document.getElementById("stop").onclick = function () {
            clearInterval(timer);
            document.getElementById("time").innerText = "90초";
            mediaRecorder.stop(0);
            const blob = new Blob(parts, {
                type: "video/webm"
            });
            url = URL.createObjectURL(blob);
        }


        // 녹화영상 재생
        document.getElementById("play").onclick = function () {
            document.getElementById("replay_video").srcObject = null;
            document.getElementById("replay_video").src = url;
            document.getElementById("replay_video").controls = true;
            document.getElementById("replay_video").play();
        }


        // 녹화영상 다운로드
        document.getElementById("download").onclick = function () {
            const videooo = document.createElement("a");
            document.body.appendChild(videooo);
            videooo.href = url;
            videooo.download = "interview_video.webm";
            videooo.click();
        }
    }
</script>

{% endblock %}